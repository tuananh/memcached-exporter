package:
  name: memcached-exporter
  version: 0.11.2
  epoch: 0
  description: Exports metrics from memcached servers for consumption by Prometheus.
  copyright:
    - license: Apache-2.0

environment:
  contents:
    repositories:
      - https://packages.wolfi.dev/os
    keyring:
      - https://packages.wolfi.dev/os/wolfi-signing.rsa.pub
    packages:
      - busybox
      - ca-certificates-bundle
      - go
      
pipeline:
  # git-checkout instead of go/install so that we can manually patch as well as passing git revision
  # to go build command
  - uses: git-checkout
    with:
      repository: https://github.com/prometheus/memcached_exporter
      tag: v${{package.version}}
      expected-commit: 48795923bbe6c23eb044c522283e0d865bffbc77
      destination: memcached_exporter

  # TODO: remove this when it's fixed upstream
  - runs: |
      cd memcached_exporter
      # Mitigate GHSA-hw7c-3rfg-p46j
      go get google.golang.org/protobuf@v1.29.1
  - runs: |
      mkdir -p ${{targets.destdir}}/bin
      cd memcached_exporter

      GO_LDFLAGS="-X github.com/prometheus/common/version.Version=${{package.version}}
        -X github.com/prometheus/common/version.Revision=$(git rev-parse --short HEAD)
        -X github.com/prometheus/common/version.Branch=HEAD
        -X github.com/prometheus/common/version.BuildUser=$USER@$HOSTNAME
        -X github.com/prometheus/common/version.BuildDate=$(date -u "+%Y%m%d-%H:%M:%S" ${SOURCE_DATE_EPOCH:+-d @$SOURCE_DATE_EPOCH})"
        
      go build \
        -tags netgo \
        -ldflags "$GO_LDFLAGS" \
        -o ${{targets.destdir}}/bin/memcached_exporter \
        ./cmd/memcached_exporter
  - uses: strip